input {
  udp {
    port => 2050
    codec => netflow {
      ecs_compatibility => v1
    }
  }
}

filter {
  # ECS netflow codec preserves [netflow] subfields for bytes/pkts
  ruby {
    code => "
      event.set('[netflow][in_bytes]', event.get('[netflow][in_bytes]').to_i * 4096) rescue nil
      event.set('[netflow][out_bytes]', event.get('[netflow][out_bytes]').to_i * 4096) rescue nil
      event.set('[netflow][in_pkts]', event.get('[netflow][in_pkts]').to_i * 4096) rescue nil
      event.set('[netflow][out_pkts]', event.get('[netflow][out_pkts]').to_i * 4096) rescue nil
    "
  }
}

output {
  elasticsearch {
    hosts => ["https://es-remote:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    # Must match your index_template: "netflow-data-*"
    index => "netflow-data-default"
    ssl_enabled => true
    ssl_certificate_authorities => ["/usr/share/logstash/ca.crt"]
    ssl_verification_mode => "none"
  }
}
